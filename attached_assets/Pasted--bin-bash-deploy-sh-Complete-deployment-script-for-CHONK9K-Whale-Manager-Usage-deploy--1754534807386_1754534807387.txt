#!/bin/bash

# deploy.sh - Complete deployment script for $CHONK9K Whale Manager

# Usage: ./deploy.sh [production|staging|development]

set -e

# Colors for output

RED=â€™\033[0;31mâ€™
GREEN=â€™\033[0;32mâ€™
YELLOW=â€™\033[1;33mâ€™
BLUE=â€™\033[0;34mâ€™
NC=â€™\033[0mâ€™ # No Color

# Configuration

PROJECT_NAME=â€œchonk9k-whale-managerâ€
DOCKER_IMAGE=â€œboomchainlab/$PROJECT_NAMEâ€
GITHUB_REPO=â€œBoomchainlab/chonk9k-whale-manager-deploymentâ€

# Environment (default to production)

ENVIRONMENT=${1:-production}
ENV_FILE=â€.env.$ENVIRONMENTâ€

# Functions

log_info() {
echo -e â€œ${BLUE}[INFO]${NC} $1â€
}

log_success() {
echo -e â€œ${GREEN}[SUCCESS]${NC} $1â€
}

log_warn() {
echo -e â€œ${YELLOW}[WARN]${NC} $1â€
}

log_error() {
echo -e â€œ${RED}[ERROR]${NC} $1â€
}

check_dependencies() {
log_info â€œChecking dependenciesâ€¦â€

\`\`\`
command -v node >/dev/null 2>&1 || { log_error "Node.js is required but not installed."; exit 1; }
command -v npm >/dev/null 2>&1 || { log_error "npm is required but not installed."; exit 1; }
command -v docker >/dev/null 2>&1 || { log_error "Docker is required but not installed."; exit 1; }

log_success "All dependencies found"
\`\`\`

}

setup_environment() {
log_info â€œSetting up $ENVIRONMENT environmentâ€¦â€

\`\`\`
if [[ ! -f "$ENV_FILE" ]]; then
    log_warn "Environment file $ENV_FILE not found. Creating from template..."
    
    cat > "$ENV_FILE" << EOF
\`\`\`

# $CHONK9K Whale Manager - $ENVIRONMENT Configuration

NODE_ENV=$ENVIRONMENT
PORT=3000

# Solana Configuration

RPC_URL=https://api.mainnet-beta.solana.com
MINT_ADDRESS=DnUsQnwNot38V9JbisNC18VHZkae1eKK5N2Dgy55pump
WHALE_THRESHOLD=100000
SCAN_INTERVAL_MS=300000

# Monitoring

ENABLE_REALTIME=true
ENABLE_PRICE_TRACKING=true
ENABLE_METRICS=true

# Alerts

ALERT_NEW_WHALE=true
ALERT_WHALE_EXIT=true
ALERT_LARGE_TRANSFER=true
ALERT_PRICE_IMPACT=true

# Discord Integration (REPLACE WITH YOUR WEBHOOK)

WEBHOOK_URL=https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN

# Optional: Slack, Telegram, Email

# SLACK_WEBHOOK=https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK

# TELEGRAM_BOT_TOKEN=YOUR_TELEGRAM_BOT_TOKEN

# TELEGRAM_CHAT_ID=YOUR_TELEGRAM_CHAT_ID

# Database (Optional)

# DATABASE_URL=mongodb://localhost:27017/chonk9k-whales

# Security

JWT_SECRET=$(openssl rand -base64 32)
BCRYPT_ROUNDS=12

# Rate Limiting

API_RATE_LIMIT=100

# Logging

LOG_LEVEL=info
EOF

\`\`\`
    log_warn "Please edit $ENV_FILE with your actual configuration before continuing."
    log_warn "Especially update the WEBHOOK_URL with your Discord webhook."
    read -p "Press Enter to continue after editing the file..."
fi

source "$ENV_FILE"
log_success "Environment configured for $ENVIRONMENT"
\`\`\`

}

install_dependencies() {
log_info â€œInstalling Node.js dependenciesâ€¦â€
npm ci â€“only=production
log_success â€œDependencies installedâ€
}

build_application() {
log_info â€œBuilding applicationâ€¦â€
npm run build
log_success â€œApplication built successfullyâ€
}

build_docker_image() {
log_info â€œBuilding Docker imageâ€¦â€

\`\`\`
# Get version from package.json
VERSION=$(node -p "require('./package.json').version")

docker build \
    --build-arg NODE_ENV=$ENVIRONMENT \
    -t $DOCKER_IMAGE:latest \
    -t $DOCKER_IMAGE:v$VERSION \
    -t $DOCKER_IMAGE:$ENVIRONMENT \
    .

log_success "Docker image built: $DOCKER_IMAGE:latest"
\`\`\`

}

deploy_with_docker() {
log_info â€œDeploying with Dockerâ€¦â€

\`\`\`
# Stop existing container if running
if docker ps -a --format "table {{.Names}}" | grep -q "^$PROJECT_NAME\$"; then
    log_info "Stopping existing container..."
    docker stop $PROJECT_NAME || true
    docker rm $PROJECT_NAME || true
fi

# Run new container
docker run -d \
    --name $PROJECT_NAME \
    --restart unless-stopped \
    -p 3000:3000 \
    --env-file "$ENV_FILE" \
    -v "$(pwd)/data:/app/data" \
    -v "$(pwd)/logs:/app/logs" \
    $DOCKER_IMAGE:latest

log_success "Container deployed and running"

# Wait for health check
log_info "Waiting for application to be healthy..."
sleep 10

if curl -f http://localhost:3000/api/v1/health > /dev/null 2>&1; then
    log_success "Application is healthy and responding"
else
    log_error "Application health check failed"
    docker logs $PROJECT_NAME --tail 50
    exit 1
fi
\`\`\`

}

deploy_with_pm2() {
log_info â€œDeploying with PM2â€¦â€

\`\`\`
# Install PM2 if not present
if ! command -v pm2 >/dev/null 2>&1; then
    log_info "Installing PM2..."
    npm install -g pm2
fi

# Create PM2 ecosystem file
cat > ecosystem.config.js << EOF
\`\`\`

module.exports = {
apps: [{
name: â€˜$PROJECT_NAMEâ€™,
script: â€˜dist/index.jsâ€™,
instances: â€˜maxâ€™,
exec_mode: â€˜clusterâ€™,
env_file: â€˜$ENV_FILEâ€™,
max_memory_restart: â€˜512Mâ€™,
log_file: â€˜./logs/combined.logâ€™,
out_file: â€˜./logs/out.logâ€™,
error_file: â€˜./logs/error.logâ€™,
log_date_format: â€˜YYYY-MM-DD HH:mm:ss Zâ€™,
merge_logs: true,
autorestart: true,
watch: false,
max_restarts: 10,
min_uptime: â€˜10sâ€™
}]
};
EOF

\`\`\`
# Create logs directory
mkdir -p logs

# Stop existing process
pm2 stop $PROJECT_NAME 2>/dev/null || true
pm2 delete $PROJECT_NAME 2>/dev/null || true

# Start new process
pm2 start ecosystem.config.js
pm2 save

log_success "Application deployed with PM2"
\`\`\`

}

setup_nginx() {
if [[ â€œ$ENVIRONMENTâ€ != â€œproductionâ€ ]]; then
return
fi

\`\`\`
log_info "Setting up Nginx reverse proxy..."

# Create Nginx config
sudo tee /etc/nginx/sites-available/$PROJECT_NAME << EOF
\`\`\`

server {
listen 80;
server_name whale.yourdomain.com;  # Replace with your domain

\`\`\`
# Security headers
add_header X-Frame-Options DENY;
add_header X-Content-Type-Options nosniff;
add_header X-XSS-Protection "1; mode=block";

# Rate limiting
limit_req_zone \$binary_remote_addr zone=api:10m rate=10r/s;

location / {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade \$http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host \$host;
    proxy_set_header X-Real-IP \$remote_addr;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto \$scheme;
    proxy_cache_bypass \$http_upgrade;
}

location /api/ {
    limit_req zone=api burst=20 nodelay;
    proxy_pass http://localhost:3000;
    proxy_set_header Host \$host;
    proxy_set_header X-Real-IP \$remote_addr;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto \$scheme;
}
\`\`\`

}
EOF

\`\`\`
# Enable site
sudo ln -sf /etc/nginx/sites-available/$PROJECT_NAME /etc/nginx/sites-enabled/

# Test and reload Nginx
sudo nginx -t && sudo systemctl reload nginx

log_success "Nginx configured"
\`\`\`

}

setup_ssl() {
if [[ â€œ$ENVIRONMENTâ€ != â€œproductionâ€ ]]; then
return
fi

\`\`\`
log_info "Setting up SSL with Let's Encrypt..."

# Install certbot if not present
if ! command -v certbot >/dev/null 2>&1; then
    sudo apt update
    sudo apt install -y certbot python3-certbot-nginx
fi

# Get SSL certificate
sudo certbot --nginx -d whale.yourdomain.com  # Replace with your domain

log_success "SSL certificate installed"
\`\`\`

}

setup_monitoring() {
log_info â€œSetting up monitoringâ€¦â€

\`\`\`
# Create monitoring script
cat > monitor.sh << 'EOF'
\`\`\`

#!/bin/bash

# Simple monitoring script for $CHONK9K Whale Manager

LOG_FILE=â€./logs/monitor.logâ€
WEBHOOK_URL=â€${DISCORD_WEBHOOK:-$WEBHOOK_URL}â€

check_health() {
if curl -f http://localhost:3000/api/v1/health > /dev/null 2>&1; then
return 0
else
return 1
fi
}

send_alert() {
local message=â€$1â€

\`\`\`
if [[ -n "$WEBHOOK_URL" ]]; then
    curl -X POST "$WEBHOOK_URL" \
        -H "Content-Type: application/json" \
        -d "{\"content\":\"ğŸš¨ **$CHONK9K Whale Manager Alert**\n$message\"}"
fi

echo "$(date): $message" >> "$LOG_FILE"
\`\`\`

}

# Main monitoring loop

if ! check_health; then
send_alert â€œApplication health check failed! Service may be down.â€

\`\`\`
# Try to restart
if command -v pm2 >/dev/null 2>&1; then
    pm2 restart chonk9k-whale-manager
elif command -v docker >/dev/null 2>&1; then
    docker restart chonk9k-whale-manager
fi

sleep 30

if check_health; then
    send_alert "Application restarted successfully."
else
    send_alert "Failed to restart application. Manual intervention required."
fi
\`\`\`

fi
EOF

\`\`\`
chmod +x monitor.sh

# Add to crontab for regular health checks
(crontab -l 2>/dev/null; echo "*/5 * * * * $(pwd)/monitor.sh") | crontab -

log_success "Monitoring configured"
\`\`\`

}

create_startup_service() {
if [[ â€œ$ENVIRONMENTâ€ != â€œproductionâ€ ]]; then
return
fi

\`\`\`
log_info "Creating systemd service..."

sudo tee /etc/systemd/system/$PROJECT_NAME.service << EOF
\`\`\`

[Unit]
Description=$CHONK9K Whale Manager
After=network.target

[Service]
Type=forking
User=$(whoami)
WorkingDirectory=$(pwd)
ExecStart=/usr/local/bin/pm2 start ecosystem.config.js
ExecReload=/usr/local/bin/pm2 restart $PROJECT_NAME
ExecStop=/usr/local/bin/pm2 stop $PROJECT_NAME
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

\`\`\`
sudo systemctl daemon-reload
sudo systemctl enable $PROJECT_NAME

log_success "Systemd service created and enabled"
\`\`\`

}

run_tests() {
if [[ -f â€œpackage.jsonâ€ ]] && npm run test â€“if-present > /dev/null 2>&1; then
log_info â€œRunning testsâ€¦â€
npm test
log_success â€œAll tests passedâ€
else
log_warn â€œNo tests found or test script not availableâ€
fi
}

backup_database() {
log_info â€œCreating database backupâ€¦â€

\`\`\`
mkdir -p backups

if [[ -f "data/whales.json" ]]; then
    cp data/whales.json "backups/whales-$(date +%Y%m%d_%H%M%S).json"
    log_success "Database backup created"
else
    log_warn "No database file found to backup"
fi
\`\`\`

}

show_status() {
log_info â€œApplication Status:â€

\`\`\`
if command -v docker >/dev/null 2>&1 && docker ps --format "table {{.Names}}\t{{.Status}}" | grep -q "$PROJECT_NAME"; then
    echo "Docker Container:"
    docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep "$PROJECT_NAME"
fi

if command -v pm2 >/dev/null 2>&1; then
    echo "PM2 Process:"
    pm2 status $PROJECT_NAME 2>/dev/null || echo "PM2 process not found"
fi

if systemctl is-active --quiet $PROJECT_NAME 2>/dev/null; then
    echo "Service Status: Active"
fi

echo ""
echo "Health Check:"
if curl -f http://localhost:3000/api/v1/health > /dev/null 2>&1; then
    echo "âœ… Application is healthy"
    echo "ğŸŒ Dashboard: http://localhost:3000"
    echo "ğŸ“š API Docs: http://localhost:3000/docs"
else
    echo "âŒ Application health check failed"
fi
\`\`\`

}

deploy_to_vps() {
log_info â€œDeploying to VPSâ€¦â€

\`\`\`
# This would typically use rsync, scp, or Git
# For now, we'll show the manual steps

cat << EOF
\`\`\`

To deploy to a VPS:

1. Copy your project to the VPS:
   rsync -avz â€“exclude node_modules â€“exclude .git . user@your-vps:/path/to/app/
1. SSH into your VPS:
   ssh user@your-vps
1. Navigate to the app directory and run:
   cd /path/to/app
   ./deploy.sh production
1. Configure your domain DNS to point to the VPS IP
1. Update the Nginx config with your actual domain

EOF
}

print_success_message() {
cat << EOF

ğŸ‰ $CHONK9K Whale Manager Deployment Complete!

ğŸ“Š Dashboard: http://localhost:3000
ğŸ“š API Documentation: http://localhost:3000/docs
ğŸ”— WebSocket: ws://localhost:3000

ğŸš€ Your whale manager is now monitoring CHONK9K token:
â€¢ Token: DnUsQnwNot38V9JbisNC18VHZkae1eKK5N2Dgy55pump
â€¢ Threshold: $WHALE_THRESHOLD tokens
â€¢ Real-time alerts: ${ALERT_NEW_WHALE:-true}

ğŸ’° Start monetizing:

1. Share your dashboard with the CHONK9K community
1. Set up premium subscriptions
1. Offer custom whale tracking services
1. Create white-label solutions for other tokens

ğŸ“ˆ Next steps:
â€¢ Add more Solana tokens
â€¢ Implement payment processing
â€¢ Scale with additional server resources
â€¢ Build mobile app integration

Happy whale hunting! ğŸ‹

EOF
}

# Main deployment flow

main() {
log_info â€œğŸš€ Starting $CHONK9K Whale Manager deploymentâ€¦â€
log_info â€œEnvironment: $ENVIRONMENTâ€

\`\`\`
check_dependencies
setup_environment

# Backup existing data
backup_database

# Build and deploy
install_dependencies
build_application

# Choose deployment method
if [[ "$2" == "docker" ]] || command -v docker >/dev/null 2>&1; then
    build_docker_image
    deploy_with_docker
else
    deploy_with_pm2
fi

# Production-specific setup
if [[ "$ENVIRONMENT" == "production" ]]; then
    setup_nginx
    setup_ssl
    create_startup_service
    setup_monitoring
fi

# Show status
sleep 5
show_status

print_success_message

log_success "Deployment completed successfully! ğŸ‰"
\`\`\`

}

# Handle script arguments

case â€œ${1:-deploy}â€ in
â€œtestâ€)
run_tests
;;
â€œstatusâ€)
show_status
;;
â€œbackupâ€)
backup_database
;;
â€œvpsâ€)
deploy_to_vps
;;
*)
main â€œ$@â€
;;
esac
